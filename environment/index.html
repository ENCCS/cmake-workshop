<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detecting your environment &mdash; CMake Workshop</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../_static/overrides.css" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script data-domain="enccs.github.io/cmake-workshop" defer="defer" src="https://plausible.io/js/script.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Mixing C++ and Fortran" href="../cxx-fortran/" />
    <link rel="prev" title="Using CMake: tips and tricks" href="../tips-and-tricks/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            CMake Workshop
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setting up your system</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hello-cmake/">From sources to executables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake-syntax/">CMake syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hello-ctest/">Creating and running tests with CTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../probing/">Probing compilation, linking, and execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../targets/">Target-based build systems with CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies/">Finding and using dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fetch-content/">Automated dependency handling with <code class="docutils literal notranslate"><span class="pre">FetchContent</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-bindings/">Mixing Python and compiled languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips-and-tricks/">Using CMake: tips and tricks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional topics</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Detecting your environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#discovering-the-processor">Discovering the processor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#platform-and-compiler-dependent-source-code">Platform- and compiler-dependent source code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cxx-fortran/">Mixing C++ and Fortran</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zbibliography/">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CMake Workshop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Detecting your environment</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/cmake-workshop/blob/main/content/environment.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="detecting-your-environment">
<span id="environment"></span><h1>Detecting your environment<a class="headerlink" href="#detecting-your-environment" title="Permalink to this heading"></a></h1>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>How does CMake interact with the host environment?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn how to discover the operating system.</p></li>
<li><p>Learn how to discover processor characteristics.</p></li>
<li><p>Learn how to handle platform- and compiler-dependent source code.</p></li>
</ul>
</div>
<p>CMake comes pre-configured with sane defaults for a multitude of properties of
the environments in which it can be used.  Default generator, default compilers,
and compiler flags are few and most notable examples of this up-front
configuration.
Run the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cmake<span class="w"> </span>--system-information<span class="w"> </span><span class="p">|</span><span class="w"> </span>less
</pre></div>
</div>
<p>if you are curious about what kind of configuration ships for your version of
CMake and operating system.</p>
<p>In this episode, we will show how to use CMake to introspect the environment in
which we are running. This is very common in build systems, since it allows to
customize the creation of artifacts on-the-fly.</p>
<div class="admonition-discovering-the-operating-system typealong toggle-shown dropdown admonition" id="typealong-0">
<p class="admonition-title">Discovering the operating system</p>
<p>For this example, we use the special value <code class="docutils literal notranslate"><span class="pre">NONE</span></code> for the <code class="docutils literal notranslate"><span class="pre">LANGUAGES</span></code>
option: we are only interested in reporting what operating system CMake
discovers and that is independent of programming language.</p>
<p>You can find the complete, working example in
<code class="docutils literal notranslate"><span class="pre">content/code/day-1/12_OS/solution</span></code>.</p>
</div>
<section id="discovering-the-processor">
<h2>Discovering the processor<a class="headerlink" href="#discovering-the-processor" title="Permalink to this heading"></a></h2>
<p>A common customization is to apply processor-specific compiler flags. We can gain
such information on the host system with the built-in
<a class="reference internal" href="https://cmake.org/cmake/help/latest/command/cmake_host_system_information.html"><span class="xref std std-term"><code class="docutils literal notranslate">cmake_host_system_information</code></span></a> command.</p>
<div class="admonition-cmake-host-system-information signature toggle-shown dropdown admonition" id="signature-0">
<p class="admonition-title"><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/cmake_host_system_information.html"><span class="xref std std-term"><code class="docutils literal notranslate">cmake_host_system_information</code></span></a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_host_system_information</span><span class="p">(</span><span class="s">RESULT</span><span class="w"> </span><span class="s">variable</span><span class="w"> </span><span class="s">QUERY</span><span class="w"> </span><span class="s">&lt;key&gt;</span><span class="w"> </span><span class="s">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This commands accepts one or more queries on the host system and returns the result in the <code class="docutils literal notranslate"><span class="pre">variable</span></code>.</p>
</div>
<div class="admonition-processor-discovery typealong toggle-shown dropdown admonition" id="typealong-1">
<p class="admonition-title">Processor discovery</p>
<p>Once again, we use the special value <code class="docutils literal notranslate"><span class="pre">NONE</span></code> for the <code class="docutils literal notranslate"><span class="pre">LANGUAGES</span></code> option:
we are only interested in reporting what CMake discovers about the host
system and that is independent of programming language.</p>
<p>You can find the complete, working example in
<code class="docutils literal notranslate"><span class="pre">content/code/day-1/13_processor/solution</span></code>.</p>
</div>
<div class="admonition-exercise-14-get-to-know-your-host exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise 14: Get to know your host</p>
<p>The scaffold project is based on the previous typealong and can be found in
the <code class="docutils literal notranslate"><span class="pre">content/code/day-1/14_host_system_information</span></code> folder.</p>
<ol class="arabic">
<li><p>Open the help page for <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/cmake_host_system_information.html"><span class="xref std std-term"><code class="docutils literal notranslate">cmake_host_system_information</code></span></a>. Either in the
browser or in the command-line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cmake<span class="w"> </span>--help-command<span class="w"> </span>cmake_host_system_information
</pre></div>
</div>
</li>
<li><p>Extend the scaffold code to query all keys listed in the help page and
print them out.</p></li>
</ol>
<p>A working solution is in the <code class="docutils literal notranslate"><span class="pre">solution</span></code> subfolder.</p>
</div>
</section>
<section id="platform-and-compiler-dependent-source-code">
<h2>Platform- and compiler-dependent source code<a class="headerlink" href="#platform-and-compiler-dependent-source-code" title="Permalink to this heading"></a></h2>
<div class="admonition-conditional-compilation-with-preprocessor-definitions typealong toggle-shown dropdown admonition" id="typealong-2">
<p class="admonition-title">Conditional compilation with preprocessor definitions</p>
<p>Sometimes we need to write code that performs different operations based on
compile-time constants:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef IS_WINDOWS</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Hello from Windows!&quot;</span><span class="p">);</span>
<span class="cp">#elif IS_LINUX</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Hello from Linux!&quot;</span><span class="p">);</span>
<span class="cp">#elif IS_MACOS</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Hello from macOS!&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Hello from an unknown system!&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>We can achieve this with CMake with a combination of host system
introspection and the <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_compile_definitions</code></span></a> command.</p>
<p>A complete, working example is in <code class="docutils literal notranslate"><span class="pre">content/code/day-1/15_sys_preproc/solution</span></code>.</p>
</div>
<div class="admonition-target-compile-definitions signature toggle-shown dropdown admonition" id="signature-1">
<p class="admonition-title"><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_compile_definitions</code></span></a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_compile_definitions</span><span class="p">(</span><span class="s">&lt;target&gt;</span>
<span class="w">  </span><span class="s">&lt;INTERFACE|PUBLIC|PRIVATE&gt;</span><span class="w"> </span><span class="s">[items1...]</span>
<span class="w">  </span><span class="s">[&lt;INTERFACE|PUBLIC|PRIVATE&gt;</span><span class="w"> </span><span class="s">[items2...]</span><span class="w"> </span><span class="s">...]</span><span class="p">)</span>
</pre></div>
</div>
<p>Adds one (or more) compile definitions to the given <code class="docutils literal notranslate"><span class="pre">&lt;target&gt;</span></code>.</p>
</div>
<p>It might be more convenient to have a single file containing all these
compile-time constants, rather than passing them to preprocessor. This can be
achieved by having a <em>scaffold</em> file and then letting CMake configure it after
discovering the values for all the necessary compile-time constants.</p>
<div class="admonition-configure-file signature toggle-shown dropdown admonition" id="signature-2">
<p class="admonition-title"><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/configure_file.html"><span class="xref std std-term"><code class="docutils literal notranslate">configure_file</code></span></a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">configure_file</span><span class="p">(</span><span class="s">&lt;input&gt;</span><span class="w"> </span><span class="s">&lt;output&gt;</span>
<span class="w">               </span><span class="s">[COPYONLY]</span><span class="w"> </span><span class="s">[ESCAPE_QUOTES]</span><span class="w"> </span><span class="s">[@ONLY]</span>
<span class="w">               </span><span class="s">[NEWLINE_STYLE</span><span class="w"> </span><span class="s">[UNIX|DOS|WIN32|LF|CRLF]</span><span class="w"> </span><span class="s">]</span><span class="p">)</span>
</pre></div>
</div>
<p>Copies the <code class="docutils literal notranslate"><span class="pre">&lt;input&gt;</span></code> file to another file <code class="docutils literal notranslate"><span class="pre">&lt;output&gt;</span></code>, modifying its content.</p>
</div>
<div class="admonition-parameters parameters dropdown admonition" id="parameters-0">
<p class="admonition-title">Parameters</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">&lt;input&gt;</span></code></dt><dd><p>Path to the input file containing placeholders (<code class="docutils literal notranslate"><span class="pre">&#64;placeholder&#64;</span></code>) to be
replaced by the contents of the corresponding CMake variable. A relative
path is treated with respect to the value of
<code class="docutils literal notranslate"><span class="pre">CMAKE_CURRENT_SOURCE_DIR</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;output&gt;</span></code></dt><dd><p>Path to the output file or directory. A relative path is treated with
respect to the value of <code class="docutils literal notranslate"><span class="pre">CMAKE_CURRENT_BINARY_DIR</span></code>.</p>
</dd>
</dl>
</div>
<div class="admonition-exercise-16-configure-a-file exercise important admonition" id="exercise-1">
<p class="admonition-title">Exercise 16: Configure a file</p>
<p>Let’s revisit one of the previous exercises. Rather than print the results of
querying with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/cmake_host_system_information.html"><span class="xref std std-term"><code class="docutils literal notranslate">cmake_host_system_information</code></span></a>, we want to save the results to
a header file and then use it to print the results when running an
executable.</p>
<p>The source code for this project is in the
<code class="docutils literal notranslate"><span class="pre">content/code/day-1/16_configure</span></code> folder.  The header file <code class="docutils literal notranslate"><span class="pre">config.h.in</span></code>
contains placeholders for the values that we will detect using  CMake: u
number of physical cores, total physical memory, OS name, and OS platform.</p>
<ol class="arabic">
<li><p>Copy-paste the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> from the
<code class="docutils literal notranslate"><span class="pre">content/code/day-1/14_host_system_information</span></code> folder.</p></li>
<li><p>Adapt the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> to compile <code class="docutils literal notranslate"><span class="pre">processor-info.cpp</span></code> into an
executable with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_executable.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_executable</code></span></a>.</p></li>
<li><p>Try building. This should fail, because there is no <code class="docutils literal notranslate"><span class="pre">config.h</span></code> file
anywhere yet!</p></li>
<li><p>Open the help page for <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/configure_file.html"><span class="xref std std-term"><code class="docutils literal notranslate">configure_file</code></span></a>. Either in the browser or in the
command-line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cmake<span class="w"> </span>--help-command<span class="w"> </span>configure_file
</pre></div>
</div>
</li>
<li><p>Query the keys (number of physical cores, total physical memory, OS name,
and OS platform) using the corresponding names listed in the help page for
<a class="reference internal" href="https://cmake.org/cmake/help/latest/command/cmake_host_system_information.html"><span class="xref std std-term"><code class="docutils literal notranslate">cmake_host_system_information</code></span></a> and save them to appropriately named
variables.</p></li>
<li><p>Invoke <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/configure_file.html"><span class="xref std std-term"><code class="docutils literal notranslate">configure_file</code></span></a> to produce <code class="docutils literal notranslate"><span class="pre">config.h</span></code> from <code class="docutils literal notranslate"><span class="pre">config.h.in</span></code>.  The
configured file will be saved in the build folder, <em>i.e.</em>
<code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span></code>.</p></li>
<li><p>Try building again. This will fail too, because the header is not in the
<em>include path</em>. We can fix this with:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">processor-info</span>
<span class="w">  </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<p>A complete, working example is in the <code class="docutils literal notranslate"><span class="pre">solution</span></code> subfolder.</p>
</div>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>CMake can <em>introspect</em> the host system.</p></li>
<li><p>You can build source code differently, based on the OS, the processor, the
compiler, or any combination thereof.</p></li>
<li><p>You can generate source code when configuring the project with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/configure_file.html"><span class="xref std std-term"><code class="docutils literal notranslate">configure_file</code></span></a>.</p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tips-and-tricks/" class="btn btn-neutral float-left" title="Using CMake: tips and tricks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../cxx-fortran/" class="btn btn-neutral float-right" title="Mixing C++ and Fortran" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, EuroCC National Competence Centre Sweden.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>